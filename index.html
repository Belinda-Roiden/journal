<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üìì –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet" />
<style>
  * { box-sizing: border-box; }
  body { margin: 0; background: #f5f0e8; font-family: 'Source Serif 4', Georgia, serif; }
  input, select, button { font-family: inherit; }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: #c4b49a; border-radius: 2px; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
</style>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LESSON_TYPES = ["–õ–µ–∫—Ü–∏—è", "–ü—Ä–∞–∫—Ç–∏–∫–∞", "–°–µ–º–∏–Ω–∞—Ä", "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è"];
const ATT = {
  present: { label: "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç",  short: "–ü", color: "#4a9a38", bg: "#eaf5e4", border: "#c8e8b8" },
  sick:    { label: "–ë–æ–ª–µ–∑–Ω—å",       short: "–ë", color: "#d07820", bg: "#fdf3e4", border: "#f0d8a8" },
  valid:   { label: "–£–≤–∞–∂. –ø—Ä–∏—á–∏–Ω–∞", short: "–£", color: "#3060c0", bg: "#e8edf8", border: "#b8ccf0" },
  absent:  { label: "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",   short: "–ù", color: "#c03030", bg: "#fde8e8", border: "#f0c8c8" },
};
const ATT_CYCLE = ["present", "sick", "valid", "absent"];
const mkId = () => Math.random().toString(36).slice(2, 10);
const mkCode = () => {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  return Array.from({length:8}, (_,i) => i===4?"-":chars[Math.floor(Math.random()*chars.length)]).join("");
};
const initialJournal = () => ({
  students: Array.from({length:10}, (_,i) => `–°—Ç—É–¥–µ–Ω—Ç ${i+1}`),
  subjects: Array.from({length:10}, (_,i) => ({ id: mkId(), name: `–ü—Ä–µ–¥–º–µ—Ç ${i+1}`, teacher: "", lessons: [] })),
});

// ‚îÄ‚îÄ‚îÄ Config (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ localStorage, –≤–≤–æ–¥–∏—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const loadConfig = () => ls.get("ej_config") || null;
const saveConfig = (c) => ls.set("ej_config", c);

let _cfg = null; // { binId, apiKey }
const getBinUrl = () => `https://api.jsonbin.io/v3/b/${_cfg.binId}`;

// ‚îÄ‚îÄ‚îÄ LocalStorage (—Ç–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç—ã ‚Äî –ø–∞—Ä–æ–ª–∏ –≤ –æ–±–ª–∞–∫–æ –Ω–µ –∏–¥—É—Ç) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ls = {
  get: (k) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : null; } catch { return null; } },
  set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} },
};
const loadUsers = () => ls.get("ej_users") || [];
const saveUsers = (u) => ls.set("ej_users", u);

// ‚îÄ‚îÄ‚îÄ JSONBin (–¥–∞–Ω–Ω—ã–µ –∂—É—Ä–Ω–∞–ª–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fetchJournal = async () => {
  try {
    const r = await fetch(getBinUrl() + "/latest", {
      headers: { "X-Master-Key": _cfg.apiKey, "X-Bin-Meta": "false" }
    });
    if (!r.ok) throw new Error("fetch failed");
    const d = await r.json();
    if (d && Array.isArray(d.students)) return d;
    return initialJournal();
  } catch {
    return ls.get("ej_cache") || initialJournal();
  }
};

let _saveTimer = null;
let _pendingData = null;
let _saveStatus = "saved"; // "saved" | "saving" | "pending"
let _onStatusChange = null;

const pushJournal = (d) => {
  ls.set("ej_cache", d);
  _pendingData = d;
  _saveStatus = "pending";
  if (_onStatusChange) _onStatusChange("pending");
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => _doSave(d), 600);
};

const _doSave = async (d) => {
  _saveStatus = "saving";
  if (_onStatusChange) _onStatusChange("saving");
  try {
    await fetch(getBinUrl(), {
      method: "PUT",
      headers: { "Content-Type": "application/json", "X-Master-Key": _cfg.apiKey },
      body: JSON.stringify(d)
    });
    _pendingData = null;
    _saveStatus = "saved";
    if (_onStatusChange) _onStatusChange("saved");
  } catch {
    _saveStatus = "pending";
    if (_onStatusChange) _onStatusChange("pending");
  }
};

window.addEventListener("beforeunload", () => {
  if (_pendingData && _cfg) {
    clearTimeout(_saveTimer);
    const blob = new Blob([JSON.stringify(_pendingData)], {type:"application/json"});
    navigator.sendBeacon
      ? navigator.sendBeacon(getBinUrl() + "?apikey=" + encodeURIComponent(_cfg.apiKey), blob)
      : null;
  }
});

const hashPass = async (s) => {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(s));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
};

// ‚îÄ‚îÄ‚îÄ Styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  page:    { maxWidth: 640, margin: "0 auto", padding: "16px 16px 80px", minHeight: "100vh" },
  card:    { background: "#fffdf7", border: "1px solid #e8dcc8", borderRadius: 16, overflow: "hidden", marginBottom: 12, boxShadow: "0 2px 8px rgba(120,100,70,.06)" },
  field:   { border: "1px solid #e0d5c0", borderRadius: 10, padding: "9px 12px", width: "100%", fontSize: 14, background: "#fffdf7", color: "#3a2e20", outline: "none", fontFamily: "'Source Serif 4', serif", boxSizing: "border-box" },
  label:   { display: "block", fontSize: 11, color: "#9a8a72", letterSpacing: .5, textTransform: "uppercase", marginBottom: 4 },
  btn:     (v="") => ({ cursor:"pointer", border:"none", borderRadius:12, padding:"10px 20px", fontSize:14, fontFamily:"'Source Serif 4', serif", fontWeight:600, transition:"all .15s", ...(v==="primary"?{background:"#3a2e20",color:"#f5f0e8"}:v==="danger"?{background:"#fde8e8",color:"#a83030"}:v==="ghost"?{background:"transparent",color:"#7a6a52"}:{background:"#f0ebe0",color:"#3a2e20"}) }),
  head:    { display: "flex", alignItems: "center", gap: 12, marginBottom: 20 },
  backBtn: { cursor:"pointer", background:"#f0ebe0", border:"none", borderRadius:10, width:36, height:36, display:"flex", alignItems:"center", justifyContent:"center", fontSize:18, color:"#7a6a52", flexShrink:0 },
  h1:      { fontFamily: "'Playfair Display', serif", fontSize: 22, fontWeight: 700, color: "#2a1e10", margin: 0 },
  h2:      { fontFamily: "'Playfair Display', serif", fontSize: 16, fontWeight: 600, color: "#3a2e20", margin: "0 0 12px" },
  badge:   (c="") => ({ display:"inline-block", fontSize:11, padding:"2px 10px", borderRadius:100, fontWeight:600, letterSpacing:.3, background:c==="g"?"#e8f5e2":c==="r"?"#fde8e8":c==="b"?"#e8edf5":c==="o"?"#fdf3e4":"#f0ebe0", color:c==="g"?"#3a7a28":c==="r"?"#a83030":c==="b"?"#2a4a8a":c==="o"?"#a06010":"#7a6040" }),
  inp:     (x={}) => ({ background:"transparent", border:"none", outline:"none", width:"100%", color:"#3a2e20", fontSize:14, padding:"2px 4px", borderRadius:6, fontFamily:"'Source Serif 4', serif", ...x }),
};

function Toast({ msg }) {
  if (!msg) return null;
  return <div style={{ position:"fixed", top:16, left:"50%", transform:"translateX(-50%)", background:"#3a2e20", color:"#f5f0e8", padding:"8px 20px", borderRadius:100, fontSize:13, zIndex:9999, boxShadow:"0 4px 12px rgba(0,0,0,.2)", whiteSpace:"nowrap" }}>{msg}</div>;
}
function Fld({ label, children }) {
  return <div style={{ marginBottom:14 }}><label style={S.label}>{label}</label>{children}</div>;
}
function Err({ msg }) {
  if (!msg) return null;
  return <div style={{ background:"#fde8e8", color:"#a83030", padding:"8px 12px", borderRadius:10, fontSize:13, marginBottom:16 }}>{msg}</div>;
}

// ‚îÄ‚îÄ‚îÄ Config setup screen (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –≤–≤–æ–¥ JSONBin –¥–∞–Ω–Ω—ã—Ö) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ConfigSetupScreen({ onDone }) {
  const [f, setF] = useState({ binId:"", apiKey:"" });
  const [err, setErr] = useState(""); const [loading, setLoading] = useState(false);
  const set = k => e => setF(p=>({...p,[k]:e.target.value}));
  const submit = async () => {
    if (!f.binId.trim() || !f.apiKey.trim()) return setErr("–ó–∞–ø–æ–ª–Ω–∏ –æ–±–∞ –ø–æ–ª—è");
    setLoading(true); setErr("");
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á –∏ bin —Ä–∞–±–æ—Ç–∞—é—Ç
    try {
      const r = await fetch(`https://api.jsonbin.io/v3/b/${f.binId.trim()}/latest`, {
        headers: { "X-Master-Key": f.apiKey.trim(), "X-Bin-Meta": "false" }
      });
      if (!r.ok) throw new Error();
    } catch {
      setErr("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å Bin ID –∏ API-–∫–ª—é—á–∞.");
      setLoading(false); return;
    }
    const cfg = { binId: f.binId.trim(), apiKey: f.apiKey.trim() };
    saveConfig(cfg);
    onDone(cfg);
  };
  return (
    <div style={{ ...S.page, display:"flex", flexDirection:"column", justifyContent:"center", minHeight:"100vh" }}>
      <div style={{ ...S.card, padding:28 }}>
        <h1 style={{ ...S.h1, fontSize:22, marginBottom:6 }}>üìì –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª</h1>
        <p style={{ color:"#9a8a72", fontSize:14, marginBottom:8 }}>–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫. –î–ª—è —Ä–∞–±–æ—Ç—ã –∂—É—Ä–Ω–∞–ª–∞ –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ JSONBin.</p>
        <div style={{ background:"#f0ebe0", borderRadius:12, padding:"10px 14px", fontSize:13, color:"#7a6040", marginBottom:20, lineHeight:1.6 }}>
          <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:</b><br/>
          1. –ó–∞–π–¥–∏ –Ω–∞ <b>jsonbin.io</b> –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è<br/>
          2. –í —Ä–∞–∑–¥–µ–ª–µ <b>API Keys</b> —Å–∫–æ–ø–∏—Ä—É–π –∫–ª—é—á<br/>
          3. –í —Ä–∞–∑–¥–µ–ª–µ <b>Bins</b> —Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π bin (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ: <code>{`{"ready":true}`}</code>)<br/>
          4. –°–∫–æ–ø–∏—Ä—É–π ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ bin
        </div>
        <Err msg={err} />
        <Fld label="Bin ID"><input value={f.binId} onChange={set("binId")} style={S.field} placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 64f3a1c85e6d3a7b8c9d1234" /></Fld>
        <Fld label="API-–∫–ª—é—á (Master Key)"><input value={f.apiKey} onChange={set("apiKey")} style={S.field} placeholder="$2a$10$..." /></Fld>
        <button onClick={submit} disabled={loading} style={{ ...S.btn("primary"), width:"100%", padding:13, borderRadius:12, fontSize:15 }}>
          {loading ? "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶" : "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"}
        </button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Recovery code generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const genRecoveryCode = () => {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  const seg = () => Array.from({length:4}, ()=>chars[Math.floor(Math.random()*chars.length)]).join("");
  return `${seg()}-${seg()}-${seg()}`;
};

// ‚îÄ‚îÄ‚îÄ Auth screens ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function SetupScreen({ onDone }) {
  const [f, setF] = useState({ name:"", group:"", pass:"", pass2:"" });
  const [err, setErr] = useState("");
  const [loading, setLoading] = useState(false);
  const [recoveryCode, setRecoveryCode] = useState(null);
  const set = k => e => setF(p=>({...p,[k]:e.target.value}));

  const submit = async () => {
    if (!f.name.trim()) return setErr("–í–≤–µ–¥–∏ –§–ò–û");
    if (!f.group.trim()) return setErr("–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã");
    if (f.pass.length < 4) return setErr("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞");
    if (f.pass !== f.pass2) return setErr("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç");
    setLoading(true);
    const code = genRecoveryCode();
    const user = {
      id: mkId(),
      name: f.name.trim(),
      group: f.group.trim(),
      role: "admin",
      passHash: await hashPass(f.pass),
      recoveryHash: await hashPass(code + f.group.trim().toLowerCase()),
    };
    saveUsers([user]);
    setRecoveryCode(code);
    setLoading(false);
  };

  // ‚îÄ‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚îÄ‚îÄ
  if (recoveryCode) {
    const users = loadUsers();
    const user = users[0];
    return (
      <div style={{ ...S.page, display:"flex", flexDirection:"column", justifyContent:"center", minHeight:"100vh" }}>
        <div style={{ ...S.card, padding:28 }}>
          <div style={{ fontSize:28, marginBottom:8, textAlign:"center" }}>üîê</div>
          <h1 style={{ ...S.h1, fontSize:20, marginBottom:8, textAlign:"center" }}>–°–æ—Ö—Ä–∞–Ω–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥!</h1>
          <p style={{ color:"#9a8a72", fontSize:13, marginBottom:20, textAlign:"center" }}>
            –ï—Å–ª–∏ –∑–∞–±—É–¥–µ—à—å –ø–∞—Ä–æ–ª—å, –æ–Ω –ø–æ–º–æ–∂–µ—Ç –µ–≥–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–º–µ—Å—Ç–µ —Å –Ω–æ–º–µ—Ä–æ–º –≥—Ä—É–ø–ø—ã. –ü–æ–∫–∞–∂–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
          </p>
          <div style={{ background:"#f0ebe0", border:"2px dashed #c4a060", borderRadius:14, padding:"18px 12px", textAlign:"center", marginBottom:20 }}>
            <div style={{ fontFamily:"monospace", fontSize:22, fontWeight:700, color:"#3a2e20", letterSpacing:3 }}>{recoveryCode}</div>
            <button onClick={()=>{navigator.clipboard?.writeText(recoveryCode);}} style={{ marginTop:10, ...S.btn(""), padding:"5px 14px", fontSize:12, borderRadius:8 }}>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <p style={{ color:"#c03030", fontSize:12, marginBottom:20, textAlign:"center", fontWeight:600 }}>
            ‚ö†Ô∏è –ó–∞–ø–∏—à–∏ –∫–æ–¥ –≤ –Ω–∞–¥—ë–∂–Ω–æ–µ –º–µ—Å—Ç–æ. –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —ç—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –∫–æ–¥ —É–≤–∏–¥–µ—Ç—å –Ω–µ–ª—å–∑—è.
          </p>
          <button onClick={()=>onDone(user)} style={{ ...S.btn("primary"), width:"100%", padding:13, borderRadius:12, fontSize:15 }}>
            –Ø —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞ ‚Äî –≤–æ–π—Ç–∏ –≤ –∂—É—Ä–Ω–∞–ª
          </button>
        </div>
      </div>
    );
  }

  return (
    <div style={{ ...S.page, display:"flex", flexDirection:"column", justifyContent:"center", minHeight:"100vh" }}>
      <div style={{ ...S.card, padding:28 }}>
        <h1 style={{ ...S.h1, fontSize:24, marginBottom:6 }}>üìì –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª</h1>
        <p style={{ color:"#9a8a72", fontSize:14, marginBottom:10 }}>–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫. –°–æ–∑–¥–∞–π –∞–∫–∫–∞—É–Ω—Ç —Å—Ç–∞—Ä–æ—Å—Ç—ã.</p>
        <p style={{ fontSize:13, margin:"0 0 18px" }}>
          <a href="./–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è.md" target="_blank" rel="noreferrer" style={{ color:"#7a6040", textDecoration:"underline" }}>
            –û—Ç–∫—Ä—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∂—É—Ä–Ω–∞–ª–æ–º
          </a>
        </p>
        <Err msg={err} />
        <Fld label="–§–ò–û —Å—Ç–∞—Ä–æ—Å—Ç—ã"><input value={f.name} onChange={set("name")} style={S.field} placeholder="–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞" /></Fld>
        <Fld label="–ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã"><input value={f.group} onChange={set("group")} style={S.field} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–ï–†-301" /></Fld>
        <Fld label="–ü–∞—Ä–æ–ª—å"><input type="password" value={f.pass} onChange={set("pass")} style={S.field} /></Fld>
        <Fld label="–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª—å"><input type="password" value={f.pass2} onChange={set("pass2")} style={S.field} onKeyDown={e=>e.key==="Enter"&&submit()} /></Fld>
        <button onClick={submit} disabled={loading} style={{ ...S.btn("primary"), width:"100%", padding:13, borderRadius:12, fontSize:15 }}>
          {loading?"–°–æ–∑–¥–∞—ë–º‚Ä¶":"–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç"}
        </button>
      </div>
    </div>
  );
}

function ResetScreen({ onBack, onReset }) {
  const [f, setF] = useState({ code:"", group:"", pass:"", pass2:"" });
  const [err, setErr] = useState(""); const [loading, setLoading] = useState(false);
  const set = k => e => setF(p=>({...p,[k]:e.target.value}));
  const submit = async () => {
    if (!f.code.trim() || !f.group.trim()) return setErr("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è");
    if (f.pass.length < 4) return setErr("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞");
    if (f.pass !== f.pass2) return setErr("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç");
    setLoading(true);
    const users = loadUsers();
    if (users.length === 0) { setErr("–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"); setLoading(false); return; }
    const user = users[0];
    const checkHash = await hashPass(f.code.trim().toUpperCase() + f.group.trim().toLowerCase());
    if (checkHash !== user.recoveryHash) { setErr("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –Ω–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã"); setLoading(false); return; }
    const newHash = await hashPass(f.pass);
    const newCode = genRecoveryCode();
    const newRecoveryHash = await hashPass(newCode + f.group.trim().toLowerCase());
    const updated = { ...user, passHash: newHash, recoveryHash: newRecoveryHash };
    saveUsers([updated]);
    onReset(updated, newCode);
  };
  return (
    <div style={{ ...S.page, display:"flex", flexDirection:"column", justifyContent:"center", minHeight:"100vh" }}>
      <div style={{ ...S.card, padding:28 }}>
        <div style={S.head}><button style={S.backBtn} onClick={onBack}>‚Üê</button><h1 style={{ ...S.h1, fontSize:20 }}>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h1></div>
        <Err msg={err} />
        <Fld label="–†–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥"><input value={f.code} onChange={set("code")} style={S.field} placeholder="XXXX-XXXX-XXXX" /></Fld>
        <Fld label="–ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã"><input value={f.group} onChange={set("group")} style={S.field} placeholder="–ö–∞–∫ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" /></Fld>
        <Fld label="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"><input type="password" value={f.pass} onChange={set("pass")} style={S.field} /></Fld>
        <Fld label="–ü–æ–≤—Ç–æ—Ä–∏ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"><input type="password" value={f.pass2} onChange={set("pass2")} style={S.field} onKeyDown={e=>e.key==="Enter"&&submit()} /></Fld>
        <button onClick={submit} disabled={loading} style={{ ...S.btn("primary"), width:"100%", padding:13, borderRadius:12, fontSize:15 }}>
          {loading?"–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶":"–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å"}
        </button>
      </div>
    </div>
  );
}

function LoginScreen({ onDone }) {
  const [f, setF] = useState({ name:"", pass:"" });
  const [err, setErr] = useState(""); const [loading, setLoading] = useState(false);
  const [screen, setScreen] = useState("login"); // login | reset | newcode
  const [newCode, setNewCode] = useState(null);
  const set = k => e => setF(p=>({...p,[k]:e.target.value}));

  const submit = async () => {
    setLoading(true); setErr("");
    const users = loadUsers();
    const h = await hashPass(f.pass);
    const user = users.find(u => u.name.toLowerCase()===f.name.trim().toLowerCase() && u.passHash===h);
    if (!user) { setErr("–ù–µ–≤–µ—Ä–Ω–æ–µ –§–ò–û –∏–ª–∏ –ø–∞—Ä–æ–ª—å"); setLoading(false); return; }
    onDone(user);
  };

  if (screen==="reset") return (
    <ResetScreen onBack={()=>setScreen("login")} onReset={(user, code)=>{ setNewCode(code); setScreen("newcode"); }} />
  );

  if (screen==="newcode") return (
    <div style={{ ...S.page, display:"flex", flexDirection:"column", justifyContent:"center", minHeight:"100vh" }}>
      <div style={{ ...S.card, padding:28 }}>
        <div style={{ fontSize:28, marginBottom:8, textAlign:"center" }}>‚úÖ</div>
        <h1 style={{ ...S.h1, fontSize:20, marginBottom:8, textAlign:"center" }}>–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω!</h1>
        <p style={{ color:"#9a8a72", fontSize:13, marginBottom:16, textAlign:"center" }}>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥. –°–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ!</p>
        <div style={{ background:"#f0ebe0", border:"2px dashed #c4a060", borderRadius:14, padding:"18px 12px", textAlign:"center", marginBottom:16 }}>
          <div style={{ fontFamily:"monospace", fontSize:22, fontWeight:700, color:"#3a2e20", letterSpacing:3 }}>{newCode}</div>
          <button onClick={()=>navigator.clipboard?.writeText(newCode)} style={{ marginTop:10, ...S.btn(""), padding:"5px 14px", fontSize:12, borderRadius:8 }}>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <p style={{ color:"#c03030", fontSize:12, marginBottom:20, textAlign:"center", fontWeight:600 }}>‚ö†Ô∏è –°—Ç–∞—Ä—ã–π –∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.</p>
        <button onClick={()=>setScreen("login")} style={{ ...S.btn("primary"), width:"100%", padding:13, borderRadius:12, fontSize:15 }}>–í–æ–π—Ç–∏ —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º</button>
      </div>
    </div>
  );

  return (
    <div style={{ ...S.page, display:"flex", flexDirection:"column", justifyContent:"center", minHeight:"100vh" }}>
      <div style={{ ...S.card, padding:28 }}>
        <h1 style={{ ...S.h1, fontSize:24, marginBottom:6 }}>üìì –ñ—É—Ä–Ω–∞–ª</h1>
        <p style={{ color:"#9a8a72", fontSize:14, marginBottom:24 }}>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</p>
        <Err msg={err} />
        <Fld label="–§–ò–û"><input value={f.name} onChange={set("name")} style={S.field} placeholder="–¢–æ—á–Ω–æ –∫–∞–∫ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" /></Fld>
        <Fld label="–ü–∞—Ä–æ–ª—å"><input type="password" value={f.pass} onChange={set("pass")} style={S.field} onKeyDown={e=>e.key==="Enter"&&submit()} /></Fld>
        <button onClick={submit} disabled={loading} style={{ ...S.btn("primary"), width:"100%", padding:13, borderRadius:12, fontSize:15, marginBottom:12 }}>
          {loading?"–í—Ö–æ–¥–∏–º‚Ä¶":"–í–æ–π—Ç–∏"}
        </button>
        <button onClick={()=>setScreen("reset")} style={{ ...S.btn("ghost"), width:"100%", padding:10, fontSize:13, marginBottom:4 }}>
          –ó–∞–±—ã–ª–∞ –ø–∞—Ä–æ–ª—å
        </button>
        <button onClick={()=>{ if(window.confirm("–°–±—Ä–æ—Å–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ? –î–∞–Ω–Ω—ã–µ –∂—É—Ä–Ω–∞–ª–∞ –Ω–µ –ø–æ—Å—Ç—Ä–∞–¥–∞—é—Ç ‚Äî –æ–Ω–∏ –≤ –æ–±–ª–∞–∫–µ. –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ.")) { localStorage.removeItem("ej_users"); location.reload(); } }} style={{ ...S.btn("ghost"), width:"100%", padding:8, fontSize:11, color:"#b0a080" }}>
          –°–º–µ–Ω–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ / —Å–±—Ä–æ—Å–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </button>
      </div>
    </div>
  );
}



// ‚îÄ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App() {
  const [appState, setAppState] = useState("loading");
  const [user, setUser] = useState(null);
  const [data, setData] = useState(null);
  const [screen, setScreen] = useState({ type:"main" });
  const [toast, setToast] = useState(null);
  const [saveStatus, setSaveStatus] = useState("saved"); // "saved"|"saving"|"pending"
  const restoreInputRef = useRef(null);

  useEffect(() => {
    _onStatusChange = setSaveStatus;
    return () => { _onStatusChange = null; };
  }, []);

  useEffect(() => {
    const cfg = loadConfig();
    if (!cfg) { setAppState("config"); return; }
    _cfg = cfg;
    (async () => {
      const users = loadUsers();
      const d = await fetchJournal();
      setData(d);
      setAppState(users.length===0 ? "setup" : "login");
    })();
  }, []);

  const showToast = (msg) => { setToast(msg); setTimeout(()=>setToast(null),2500); };

  const saveJournal = (nd) => {
    setData(nd);
    pushJournal(nd);
  };

  const handleLogin = async (u) => {
    setUser(u);
    setAppState("loading-data");
    const d = await fetchJournal();
    setData(d);
    setAppState("app");
    setScreen({type:"main"});
  };

  if (appState==="loading" || appState==="loading-data") return (
    <div style={{ display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", height:"100vh", gap:12, fontFamily:"'Playfair Display', serif", color:"#7a6a52" }}>
      <div style={{ fontSize:18 }}>{appState==="loading-data" ? "–ó–∞–≥—Ä—É–∂–∞–µ–º –∂—É—Ä–Ω–∞–ª‚Ä¶" : "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶"}</div>
      <div style={{ fontSize:12, color:"#b0a080" }}>–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –æ–±–ª–∞–∫—É</div>
    </div>
  );
  if (appState==="config") return <ConfigSetupScreen onDone={(cfg)=>{ _cfg=cfg; const users=loadUsers(); setAppState(users.length===0?"setup":"login"); }} />;
  if (appState==="setup") return <SetupScreen onDone={handleLogin} />;
  if (appState==="login") return <LoginScreen onDone={handleLogin} />;

  const isAdmin = user.role==="admin";
  const updateSubject = (sid, upd) => { saveJournal({...data, subjects:data.subjects.map(s=>s.id===sid?{...s,...upd}:s)}); };
  const updateLesson = (sid, lid, upd) => { saveJournal({...data, subjects:data.subjects.map(s=>s.id===sid?{...s,lessons:s.lessons.map(l=>l.id===lid?{...l,...upd}:l)}:s)}); };
  const addLesson = (sid) => {
    const nl = { id:mkId(), date:new Date().toISOString().split("T")[0], topic:"", type:"–õ–µ–∫—Ü–∏—è", hours:2, attendance:{}, signature:null };
    const subj = data.subjects.find(s=>s.id===sid);
    saveJournal({...data, subjects:data.subjects.map(s=>s.id===sid?{...s,lessons:[...s.lessons,nl]}:s)});
    return nl.id;
  };
  const deleteLesson = (sid, lid) => {
    saveJournal({...data, subjects:data.subjects.map(s=>s.id===sid?{...s,lessons:s.lessons.filter(l=>l.id!==lid)}:s)});
    setScreen({type:"subject",subjectId:sid}); showToast("–ó–∞–Ω—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ");
  };
  const cycleAtt = (sid, lid, idx) => {
    const subj = data.subjects.find(s=>s.id===sid);
    const les = subj.lessons.find(l=>l.id===lid);
    const cur = les.attendance[idx]||"present";
    const next = ATT_CYCLE[(ATT_CYCLE.indexOf(cur)+1)%ATT_CYCLE.length];
    updateLesson(sid, lid, {attendance:{...les.attendance,[idx]:next}});
  };
  const totalHours = (subj) => subj.lessons.reduce((s,l)=>s+(Number(l.hours)||0),0);
  const attCount = (les, st) => data.students.filter((_,i)=>(les.attendance[i]||"present")===st).length;

  const subject = screen.subjectId ? data.subjects.find(s=>s.id===screen.subjectId) : null;
  const lesson = (subject&&screen.lessonId) ? subject.lessons.find(l=>l.id===screen.lessonId) : null;

  if (screen.type==="codes") return null;

  if (screen.type==="students") {
    const addStudent = () => {
      const s = [...data.students, `–°—Ç—É–¥–µ–Ω—Ç ${data.students.length+1}`];
      saveJournal({...data, students:s});
      showToast("–°—Ç—É–¥–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
    };
    const removeStudent = (i) => {
      if (data.students.length <= 1) return showToast("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞");
      if (!window.confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ ¬´${data.students[i]}¬ª? –î–∞–Ω–Ω—ã–µ –æ –µ–≥–æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≤–æ –≤—Å–µ—Ö –∑–∞–Ω—è—Ç–∏—è—Ö —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ –Ω–æ–º–µ—Ä—É.`)) return;
      const s = data.students.filter((_,idx)=>idx!==i);
      saveJournal({...data, students:s});
      showToast("–°—Ç—É–¥–µ–Ω—Ç —É–¥–∞–ª—ë–Ω");
    };
    // quick total absences per student across all subjects
    const totalAbsHours = (idx) => {
      let h = 0;
      data.subjects.forEach(subj => subj.lessons.forEach(les => {
        const st = les.attendance[idx]||"present";
        if (st !== "present") h += Number(les.hours)||0;
      }));
      return h;
    };
    return (
      <div style={S.page}>
        <Toast msg={toast}/>
        <div style={S.head}>
          <button style={S.backBtn} onClick={()=>setScreen({type:"main"})}>‚Üê</button>
          <h1 style={S.h1}>–°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h1>
          <span style={{ marginLeft:"auto", fontSize:13, color:"#9a8a72" }}>{data.students.length} —á–µ–ª.</span>
        </div>
        <div style={{ ...S.card, padding:16 }}>
          {data.students.map((name,i)=>{
            const absH = totalAbsHours(i);
            return (
              <div key={i} style={{ display:"flex", alignItems:"center", gap:8, padding:"8px 0", borderBottom:i<data.students.length-1?"1px solid #f0e8d8":"none" }}>
                <span style={{ width:24, textAlign:"right", color:"#b0a080", fontSize:13, fontFamily:"monospace", flexShrink:0 }}>{i+1}.</span>
                <input style={S.inp({fontSize:15,flex:1})} value={name} onChange={e=>{const s=[...data.students];s[i]=e.target.value;saveJournal({...data,students:s});}} placeholder={`–°—Ç—É–¥–µ–Ω—Ç ${i+1}`}/>
                {absH > 0 && <span style={{ fontSize:11, color:"#c03030", fontWeight:600, flexShrink:0 }}>{absH} —á.</span>}
                <button onClick={()=>setScreen({type:"student",studentIdx:i})} style={{ background:"#f0ebe0", border:"none", borderRadius:8, padding:"4px 10px", fontSize:12, color:"#7a5a30", cursor:"pointer", flexShrink:0 }}>–ü—Ä–æ—Ñ–∏–ª—å ‚Üí</button>
                <button onClick={()=>removeStudent(i)} style={{ background:"none", border:"none", cursor:"pointer", color:"#d0a0a0", fontSize:18, padding:"0 2px", lineHeight:1, flexShrink:0 }}>√ó</button>
              </div>
            );
          })}
        </div>
        <button onClick={addStudent} style={{ ...S.btn("primary"), width:"100%", padding:13, borderRadius:14, fontSize:15 }}>+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</button>
      </div>
    );
  }

  // ‚îÄ‚îÄ Student profile ‚îÄ‚îÄ
  if (screen.type==="student") {
    const idx = screen.studentIdx;
    const name = data.students[idx] || `–°—Ç—É–¥–µ–Ω—Ç ${idx+1}`;

    // Calculate per-subject stats
    const subjectStats = data.subjects.map(subj => {
      let sick=0, valid=0, absent=0, present=0;
      subj.lessons.forEach(les => {
        const h = Number(les.hours)||0;
        const st = les.attendance[idx]||"present";
        if (st==="present") present+=h;
        else if (st==="sick") sick+=h;
        else if (st==="valid") valid+=h;
        else if (st==="absent") absent+=h;
      });
      const totalLessonHours = present+sick+valid+absent;
      return { subj, sick, valid, absent, present, totalLessonHours };
    }).filter(s=>s.totalLessonHours>0); // skip subjects with no lessons yet

    const totSick   = subjectStats.reduce((a,s)=>a+s.sick,0);
    const totValid  = subjectStats.reduce((a,s)=>a+s.valid,0);
    const totAbsent = subjectStats.reduce((a,s)=>a+s.absent,0);
    const totAll    = totSick+totValid+totAbsent;

    return (
      <div style={S.page}>
        <Toast msg={toast}/>
        <div style={S.head}>
          <button style={S.backBtn} onClick={()=>setScreen({type:"students"})}>‚Üê</button>
          <div style={{ flex:1 }}>
            <h1 style={{ ...S.h1, fontSize:19 }}>{name}</h1>
            <div style={{ fontSize:13, color:"#9a8a72" }}>–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞</div>
          </div>
        </div>

        {/* Summary card */}
        <div style={{ ...S.card, padding:16, marginBottom:12 }}>
          <h2 style={S.h2}>–ò—Ç–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤</h2>
          {totAll === 0 ? (
            <div style={{ color:"#4a9a38", fontWeight:600, fontSize:15 }}>‚úì –ü—Ä–æ–ø—É—Å–∫–æ–≤ –Ω–µ—Ç</div>
          ) : (
            <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:8 }}>
              {[
                { label:"–ë–æ–ª–µ–∑–Ω—å", val:totSick,   color:ATT.sick.color,   bg:ATT.sick.bg,   border:ATT.sick.border   },
                { label:"–£–≤–∞–∂.",   val:totValid,  color:ATT.valid.color,  bg:ATT.valid.bg,  border:ATT.valid.border  },
                { label:"–ë–µ–∑ –ø—Ä.", val:totAbsent, color:ATT.absent.color, bg:ATT.absent.bg, border:ATT.absent.border },
              ].map(({label,val,color,bg,border})=>(
                <div key={label} style={{ background:bg, border:`1px solid ${border}`, borderRadius:12, padding:"12px 10px", textAlign:"center" }}>
                  <div style={{ fontFamily:"'Playfair Display', serif", fontSize:24, fontWeight:700, color, lineHeight:1 }}>{val}</div>
                  <div style={{ fontSize:11, color, marginTop:4 }}>{label}</div>
                  <div style={{ fontSize:10, color:"#b0a080", marginTop:1 }}>—á.</div>
                </div>
              ))}
            </div>
          )}
          {totAll > 0 && <div style={{ marginTop:12, fontSize:13, color:"#9a8a72", textAlign:"right" }}>–í—Å–µ–≥–æ: <b style={{ color:"#3a2e20" }}>{totAll} —á.</b></div>}
        </div>

        {/* Per-subject breakdown */}
        {subjectStats.length === 0 ? (
          <div style={{ textAlign:"center", color:"#b0a080", padding:"30px 0", fontStyle:"italic" }}>–ó–∞–Ω—è—Ç–∏–π –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ</div>
        ) : (
          subjectStats.map(({subj,sick,valid,absent,present,totalLessonHours})=>{
            const hasAbs = sick+valid+absent > 0;
            return (
              <div key={subj.id} style={{ ...S.card, padding:16 }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom: hasAbs?12:0 }}>
                  <div style={{ flex:1 }}>
                    <div style={{ fontWeight:600, fontSize:15, color:"#2a1e10" }}>{subj.name||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</div>
                    <div style={{ fontSize:12, color:"#9a8a72", marginTop:2 }}>{subj.teacher||"‚Äî"}</div>
                  </div>
                  <div style={{ textAlign:"right", flexShrink:0 }}>
                    {hasAbs
                      ? <span style={{ ...S.badge("r"), fontSize:12 }}>{sick+valid+absent} —á. –ø—Ä–æ–ø—É—Å–∫–æ–≤</span>
                      : <span style={{ ...S.badge("g"), fontSize:12 }}>‚úì –Ω–µ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤</span>
                    }
                  </div>
                </div>
                {hasAbs && (
                  <div style={{ display:"flex", gap:6, flexWrap:"wrap" }}>
                    {sick>0   && <div style={{ display:"flex", alignItems:"center", gap:6, background:ATT.sick.bg,   border:`1px solid ${ATT.sick.border}`,   borderRadius:10, padding:"6px 12px" }}><span style={{ fontFamily:"'Playfair Display', serif", fontWeight:700, color:ATT.sick.color,   fontSize:16 }}>{sick}</span>  <span style={{ fontSize:12, color:ATT.sick.color   }}>—á. ¬∑ –ë–æ–ª–µ–∑–Ω—å</span></div>}
                    {valid>0  && <div style={{ display:"flex", alignItems:"center", gap:6, background:ATT.valid.bg,  border:`1px solid ${ATT.valid.border}`,  borderRadius:10, padding:"6px 12px" }}><span style={{ fontFamily:"'Playfair Display', serif", fontWeight:700, color:ATT.valid.color,  fontSize:16 }}>{valid}</span> <span style={{ fontSize:12, color:ATT.valid.color  }}>—á. ¬∑ –£–≤–∞–∂. –ø—Ä–∏—á–∏–Ω–∞</span></div>}
                    {absent>0 && <div style={{ display:"flex", alignItems:"center", gap:6, background:ATT.absent.bg, border:`1px solid ${ATT.absent.border}`, borderRadius:10, padding:"6px 12px" }}><span style={{ fontFamily:"'Playfair Display', serif", fontWeight:700, color:ATT.absent.color, fontSize:16 }}>{absent}</span><span style={{ fontSize:12, color:ATT.absent.color }}>—á. ¬∑ –ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã</span></div>}
                  </div>
                )}
              </div>
            );
          })
        )}
      </div>
    );
  }

  if (screen.type==="lesson" && subject && lesson) {
    const canEdit = isAdmin;
    return (
      <div style={S.page}>
        <Toast msg={toast}/>
        <div style={S.head}>
          <button style={S.backBtn} onClick={()=>setScreen({type:"subject",subjectId:subject.id})}>‚Üê</button>
          <div style={{ flex:1 }}>
            <h1 style={{ ...S.h1, fontSize:19 }}>–ó–∞–Ω—è—Ç–∏–µ</h1>
            <div style={{ fontSize:13, color:"#9a8a72" }}>{subject.name}</div>
          </div>
          {isAdmin && <button onClick={()=>{if(window.confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ?"))deleteLesson(subject.id,lesson.id);}} style={{ ...S.btn("danger"), padding:"6px 12px", fontSize:12, borderRadius:10 }}>–£–¥–∞–ª–∏—Ç—å</button>}
        </div>

        <div style={{ ...S.card, padding:16, marginBottom:12 }}>
          <h2 style={S.h2}>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
          <Fld label="–î–∞—Ç–∞"><input type="date" value={lesson.date} onChange={e=>canEdit&&updateLesson(subject.id,lesson.id,{date:e.target.value})} style={{ ...S.field, background:canEdit?"#fffdf7":"#f5f0e8" }} disabled={!canEdit}/></Fld>
          <Fld label="–¢–µ–º–∞ –∑–∞–Ω—è—Ç–∏—è"><input value={lesson.topic} onChange={e=>canEdit&&updateLesson(subject.id,lesson.id,{topic:e.target.value})} placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É‚Ä¶" style={{ ...S.field, background:canEdit?"#fffdf7":"#f5f0e8" }} disabled={!canEdit}/></Fld>
          <div style={{ display:"flex", gap:10 }}>
            <div style={{ flex:1 }}>
              <label style={S.label}>–¢–∏–ø</label>
              <select value={lesson.type} onChange={e=>canEdit&&updateLesson(subject.id,lesson.id,{type:e.target.value})} style={{ ...S.field, background:canEdit?"#fffdf7":"#f5f0e8" }} disabled={!canEdit}>
                {LESSON_TYPES.map(t=><option key={t}>{t}</option>)}
              </select>
            </div>
            <div style={{ width:90 }}>
              <label style={S.label}>–ß–∞—Å–æ–≤</label>
              <input type="number" min="1" max="12" value={lesson.hours} onChange={e=>canEdit&&updateLesson(subject.id,lesson.id,{hours:Number(e.target.value)})} style={{ ...S.field, background:canEdit?"#fffdf7":"#f5f0e8" }} disabled={!canEdit}/>
            </div>
          </div>
        </div>

        <div style={{ ...S.card, padding:16, marginBottom:12 }}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10 }}>
            <h2 style={{ ...S.h2, margin:0 }}>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h2>
            <span style={{ fontFamily:"'Playfair Display', serif", fontSize:18, fontWeight:700, color:"#3a7a28" }}>
              {attCount(lesson,"present")}<span style={{ color:"#b0a080", fontSize:13, fontWeight:400 }}>/{data.students.length}</span>
            </span>
          </div>
          <div style={{ display:"flex", gap:6, flexWrap:"wrap", marginBottom:12 }}>
            {Object.entries(ATT).map(([k,v])=>(
              <span key={k} style={{ display:"flex", alignItems:"center", gap:4, fontSize:11, color:v.color, background:v.bg, padding:"2px 8px 2px 6px", borderRadius:100, border:`1px solid ${v.border}` }}>
                <b>{v.short}</b> {v.label}
              </span>
            ))}
          </div>
          {isAdmin && <p style={{ fontSize:11, color:"#b0a080", margin:"0 0 10px" }}>–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫—Ä—É–∂–æ–∫ ‚Äî —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è: –ü ‚Üí –ë ‚Üí –£ ‚Üí –ù</p>}
          {data.students.map((name,i)=>{
            const st = lesson.attendance[i]||"present";
            const a = ATT[st];
            return (
              <div key={i} style={{ display:"flex", alignItems:"center", gap:10, padding:"7px 10px", borderRadius:10, marginBottom:3, background:a.bg, border:`1px solid ${a.border}` }}>
                <div onClick={()=>isAdmin&&cycleAtt(subject.id,lesson.id,i)} style={{ width:28, height:28, borderRadius:"50%", background:"white", border:`2px solid ${a.border}`, display:"flex", alignItems:"center", justifyContent:"center", color:a.color, fontSize:11, fontWeight:700, flexShrink:0, cursor:isAdmin?"pointer":"default", userSelect:"none" }}>
                  {a.short}
                </div>
                <span style={{ fontSize:12, color:"#9a8a72", width:20, textAlign:"right", flexShrink:0 }}>{i+1}.</span>
                <span style={{ fontSize:14, color:"#3a2e20", flex:1 }}>{name}</span>
                <span style={{ fontSize:11, color:a.color, fontWeight:600 }}>{a.label}</span>
              </div>
            );
          })}
          {isAdmin && (
            <div style={{ display:"flex", gap:8, marginTop:12 }}>
              <button onClick={()=>{const att={};data.students.forEach((_,i)=>att[i]="present");updateLesson(subject.id,lesson.id,{attendance:att});showToast("–í—Å–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç");}} style={{ ...S.btn(""), flex:1, background:"#eaf5e4", color:"#3a7a28", borderRadius:10, padding:"8px 0", fontSize:13 }}>–í—Å–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç</button>
              <button onClick={()=>{const att={};data.students.forEach((_,i)=>att[i]="absent");updateLesson(subject.id,lesson.id,{attendance:att});showToast("–í—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç");}} style={{ ...S.btn(""), flex:1, background:"#faeaea", color:"#a83030", borderRadius:10, padding:"8px 0", fontSize:13 }}>–í—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</button>
            </div>
          )}
        </div>

        <div style={{ ...S.card, padding:16 }}>
          <h2 style={S.h2}>–ü–æ–¥–ø–∏—Å—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h2>
          <div style={{ color:"#b0a080", fontSize:14, fontStyle:"italic" }}>–§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π.</div>
        </div>
      </div>
    );
  }

  if (screen.type==="subject" && subject) {
    const hours = totalHours(subject);
    return (
      <div style={S.page}>
        <Toast msg={toast}/>
        <div style={S.head}>
          <button style={S.backBtn} onClick={()=>setScreen({type:"main"})}>‚Üê</button>
          <div style={{ flex:1 }}>
            <h1 style={{ ...S.h1, fontSize:19 }}>{subject.name||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</h1>
            <div style={{ fontSize:13, color:"#9a8a72" }}>{subject.teacher||"–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω"}</div>
          </div>
          <div style={{ textAlign:"right", flexShrink:0 }}>
            <div style={{ fontFamily:"'Playfair Display', serif", fontSize:26, fontWeight:700, color:"#3a2e20", lineHeight:1 }}>{hours}</div>
            <div style={{ fontSize:11, color:"#b0a080" }}>—á–∞—Å–æ–≤</div>
          </div>
        </div>
        <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:8, marginBottom:16 }}>
          {[["üìö","–ó–∞–Ω—è—Ç–∏–π",subject.lessons.length],["‚è±","–ß–∞—Å–æ–≤",hours],["‚úç","–ü–æ–¥–ø–∏—Å–∞–Ω–æ",subject.lessons.filter(l=>l.signature).length]].map(([ic,l,v])=>(
            <div key={l} style={{ ...S.card, padding:"12px 10px", textAlign:"center", marginBottom:0 }}>
              <div style={{ fontFamily:"'Playfair Display', serif", fontSize:20, fontWeight:700, color:"#3a2e20" }}>{v}</div>
              <div style={{ fontSize:11, color:"#9a8a72" }}>{ic} {l}</div>
            </div>
          ))}
        </div>
        {isAdmin && <button onClick={()=>{const id=addLesson(subject.id);setScreen({type:"lesson",subjectId:subject.id,lessonId:id});}} style={{ ...S.btn("primary"), width:"100%", padding:13, marginBottom:16, borderRadius:14, fontSize:15 }}>+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</button>}
        {subject.lessons.length===0 && <div style={{ textAlign:"center", color:"#b0a080", padding:"40px 20px", fontStyle:"italic" }}>–ó–∞–Ω—è—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>}
        {[...subject.lessons].reverse().map(les=>{
          const dateStr = les.date?new Date(les.date+"T00:00:00").toLocaleDateString("ru-RU",{day:"numeric",month:"long"}):"‚Äî";
          const pc=attCount(les,"present"),nc=attCount(les,"absent"),sc=attCount(les,"sick"),vc=attCount(les,"valid");
          return (
            <div key={les.id} onClick={()=>setScreen({type:"lesson",subjectId:subject.id,lessonId:les.id})}
              style={{ ...S.card, padding:"14px 16px", cursor:"pointer" }}
              onMouseEnter={e=>e.currentTarget.style.boxShadow="0 4px 16px rgba(120,100,70,.12)"}
              onMouseLeave={e=>e.currentTarget.style.boxShadow="0 2px 8px rgba(120,100,70,.06)"}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:8 }}>
                <div>
                  <div style={{ fontWeight:600, fontSize:15, color:"#2a1e10" }}>{dateStr}</div>
                  <div style={{ fontSize:13, color:"#7a6a52", marginTop:2 }}>{les.topic||<em style={{ color:"#b0a080" }}>–¢–µ–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</em>}</div>
                </div>
                <div style={{ textAlign:"right", flexShrink:0 }}>
                  <span style={S.badge("b")}>{les.type}</span>
                  <div style={{ fontSize:12, color:"#b0a080", marginTop:4 }}>{les.hours} —á.</div>
                </div>
              </div>
              <div style={{ display:"flex", gap:5, flexWrap:"wrap", alignItems:"center" }}>
                {pc>0&&<span style={S.badge("g")}>–ü {pc}</span>}
                {nc>0&&<span style={S.badge("r")}>–ù {nc}</span>}
                {sc>0&&<span style={S.badge("o")}>–ë {sc}</span>}
                {vc>0&&<span style={S.badge("b")}>–£ {vc}</span>}
                {les.signature&&<span style={S.badge("")}>‚úç {les.signature.userName}</span>}
              </div>
            </div>
          );
        })}
      </div>
    );
  }

  // Main
  const addSubject = () => {
    const n = data.subjects.length + 1;
    saveJournal({...data, subjects:[...data.subjects, { id:mkId(), name:`–ü—Ä–µ–¥–º–µ—Ç ${n}`, teacher:"", lessons:[] }]});
    showToast("–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
  };
  const removeSubject = (sid) => {
    const subj = data.subjects.find(s=>s.id===sid);
    if (subj.lessons.length > 0) {
      if (!window.confirm(`–£ –ø—Ä–µ–¥–º–µ—Ç–∞ ¬´${subj.name}¬ª –µ—Å—Ç—å ${subj.lessons.length} –∑–∞–Ω—è—Ç–∏–π. –£–¥–∞–ª–∏—Ç—å –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏?`)) return;
    } else {
      if (!window.confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç ¬´${subj.name}¬ª?`)) return;
    }
    saveJournal({...data, subjects:data.subjects.filter(s=>s.id!==sid)});
    showToast("–ü—Ä–µ–¥–º–µ—Ç —É–¥–∞–ª—ë–Ω");
  };
  const getBackupFileName = () => {
    const ts = new Date().toISOString().slice(0, 19).replace(/[T:]/g, "-");
    return `journal-backup-${ts}.json`;
  };
  const extractJournalFromBackup = (raw) => {
    if (raw && raw.journal && Array.isArray(raw.journal.students) && Array.isArray(raw.journal.subjects)) return raw.journal;
    if (raw && Array.isArray(raw.students) && Array.isArray(raw.subjects)) return raw;
    return null;
  };
  const createBackup = async () => {
    const payload = {
      version: 1,
      createdAt: new Date().toISOString(),
      journal: data,
    };
    const json = JSON.stringify(payload, null, 2);

    if (window.showSaveFilePicker && window.isSecureContext) {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: getBackupFileName(),
          types: [{ description: "JSON backup", accept: { "application/json": [".json"] } }],
        });
        const writable = await handle.createWritable();
        await writable.write(json);
        await writable.close();
        showToast("–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª");
        return;
      } catch (e) {
        if (e?.name === "AbortError") return;
      }
    }

    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = getBackupFileName();
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast("–§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å–∫–∞—á–∞–Ω");
  };
  const restoreFromFile = async (file) => {
    if (!file) return;
    try {
      const text = await file.text();
      const parsed = JSON.parse(text);
      const journal = extractJournalFromBackup(parsed);
      if (!journal) {
        showToast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏");
        return;
      }
      if (!window.confirm("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞? –¢–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.")) return;
      saveJournal(journal);
      showToast("–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞");
    } catch {
      showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏");
    }
  };
  const openRestoreDialogFallback = () => {
    const input = restoreInputRef.current;
    if (!input) {
      showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞");
      return;
    }
    try {
      if (typeof input.showPicker === "function") {
        input.showPicker();
        return;
      }
    } catch {}
    input.click();
  };
  const restoreLatestBackup = async () => {
    if (window.showOpenFilePicker && window.isSecureContext) {
      try {
        const [handle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{ description: "JSON backup", accept: { "application/json": [".json"] } }],
        });
        const file = await handle.getFile();
        await restoreFromFile(file);
        return;
      } catch (e) {
        if (e?.name === "AbortError") return;
      }
    }
    openRestoreDialogFallback();
  };
  return (
    <div style={S.page}>
      <Toast msg={toast}/>
      <div style={{ marginBottom:20, display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
        <div>
          <h1 style={{ ...S.h1, fontSize:26, margin:"0 0 4px" }}>üìì –ñ—É—Ä–Ω–∞–ª –≥—Ä—É–ø–ø—ã</h1>
          <div style={{ fontSize:13, color:"#9a8a72" }}>{user.name} ¬∑ –°—Ç–∞—Ä–æ—Å—Ç–∞{user.group ? ` ¬∑ ${user.group}` : ""}</div>
        </div>
        <div style={{ display:"flex", gap:8 }}>
          {isAdmin&&<button onClick={()=>setScreen({type:"students"})} style={{ ...S.btn(""), padding:"8px 12px", fontSize:13, borderRadius:10 }}>üë§</button>}
          <button onClick={()=>{setUser(null);setAppState("login");}} style={{ ...S.btn(""), padding:"8px 12px", fontSize:13, borderRadius:10 }}>–í—ã–π—Ç–∏</button>
        </div>
      </div>
      {saveStatus !== "saved" && (
        <div style={{ display:"flex", alignItems:"center", gap:6, fontSize:12, color:"#9a8a72", marginBottom:12, padding:"6px 12px", background:"#f0ebe0", borderRadius:100, width:"fit-content" }}>
          <span style={{ display:"inline-block", width:8, height:8, borderRadius:"50%", background: saveStatus==="saving"?"#6aaa50":"#c4a060", animation:"pulse 1s infinite" }}>‚óè</span>
          {saveStatus==="saving" ? "–°–æ—Ö—Ä–∞–Ω—è–µ–º‚Ä¶" : "–û–∂–∏–¥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è‚Ä¶"}
        </div>
      )}
      {saveStatus === "saved" && (
        <div style={{ display:"flex", alignItems:"center", gap:6, fontSize:12, color:"#6aaa50", marginBottom:12, padding:"6px 12px", background:"#eaf5e4", borderRadius:100, width:"fit-content" }}>
          ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
        </div>
      )}
      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8, marginBottom:12 }}>
        <button onClick={createBackup} style={{ ...S.btn(""), width:"100%", padding:10, borderRadius:12, fontSize:13 }}>
          –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
        </button>
        <button onClick={restoreLatestBackup} style={{ ...S.btn(""), width:"100%", padding:10, borderRadius:12, fontSize:13 }}>
          –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
        </button>
      </div>
      <input
        ref={restoreInputRef}
        type="file"
        accept=".json,application/json"
        style={{ position:"fixed", left:"-9999px", top:0, width:1, height:1, opacity:0 }}
        onChange={async (e) => {
          const file = e.target.files && e.target.files[0];
          e.target.value = "";
          await restoreFromFile(file);
        }}
      />
      {data.subjects.map((subj,i)=>{
        const hours = totalHours(subj);
        return (
          <div key={subj.id} style={S.card}>
            <div style={{ display:"flex", alignItems:"flex-start", gap:12, padding:"14px 16px" }}>
              <div style={{ width:34, height:34, background:"#f0e8d8", borderRadius:10, display:"flex", alignItems:"center", justifyContent:"center", fontFamily:"'Playfair Display', serif", fontWeight:700, color:"#7a6040", fontSize:15, flexShrink:0 }}>{i+1}</div>
              <div style={{ flex:1, minWidth:0 }}>
                {isAdmin
                  ? <><input value={subj.name} onChange={e=>updateSubject(subj.id,{name:e.target.value})} style={S.inp({fontWeight:600,fontSize:15,marginBottom:2})} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"/><input value={subj.teacher} onChange={e=>updateSubject(subj.id,{teacher:e.target.value})} style={S.inp({fontSize:13,color:"#9a8a72"})} placeholder="–§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è"/></>
                  : <><div style={{ fontWeight:600, fontSize:15, color:"#2a1e10" }}>{subj.name}</div><div style={{ fontSize:13, color:"#9a8a72" }}>{subj.teacher||"‚Äî"}</div></>
                }
              </div>
              <div style={{ display:"flex", flexDirection:"column", alignItems:"flex-end", gap:4, flexShrink:0 }}>
                <div style={{ textAlign:"right" }}>
                  <div style={{ fontFamily:"'Playfair Display', serif", fontSize:22, fontWeight:700, color:"#3a2e20", lineHeight:1 }}>{hours}</div>
                  <div style={{ fontSize:11, color:"#b0a080" }}>—á.</div>
                </div>
                <button onClick={()=>removeSubject(subj.id)} style={{ background:"none", border:"none", cursor:"pointer", color:"#d0a0a0", fontSize:20, padding:"0", lineHeight:1 }} title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç">√ó</button>
              </div>
            </div>
            <button onClick={()=>setScreen({type:"subject",subjectId:subj.id})}
              style={{ width:"100%", padding:"10px 16px", background:"#f5f0e8", border:"none", borderTop:"1px solid #e8dcc8", color:"#7a5a30", fontSize:13, cursor:"pointer", fontFamily:"'Source Serif 4', serif", fontWeight:600, textAlign:"left" }}
              onMouseEnter={e=>e.currentTarget.style.background="#ede6d8"}
              onMouseLeave={e=>e.currentTarget.style.background="#f5f0e8"}>
              –û—Ç–∫—Ä—ã—Ç—å –∂—É—Ä–Ω–∞–ª ¬∑ {subj.lessons.length} –∑–∞–Ω—è—Ç–∏–π ‚Üí
            </button>
          </div>
        );
      })}
      <button onClick={addSubject} style={{ ...S.btn(""), width:"100%", padding:13, borderRadius:14, fontSize:15, marginTop:4 }}>+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
      {isAdmin&&<p style={{ textAlign:"center", fontSize:12, color:"#c0b090", fontStyle:"italic", marginTop:12 }}>–ù–∞–∂–º–∏ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ/–§–ò–û, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å ¬∑ √ó —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å</p>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
